---
kind: pipeline
type: kubernetes
name: github-metrics
platform:
  arch: arm64

trigger:
  branch:
  - main

steps:
  - name: publish
    image: plugins/kaniko-ecr
    settings:
      registry: 795250896452.dkr.ecr.us-east-1.amazonaws.com
      repo: docs/github-metrics
      dockerfile: github-metrics/Dockerfile
      context: .
      tags:
      - git-${DRONE_COMMIT_SHA:0:7}
      - latest
      access_key:
        from_secret: ecr_access_key
      secret_key:
        from_secret: ecr_secret_key
    when:
      event:
      - push

  - name: deploy-staging
    image: public.ecr.aws/kanopy/drone-helm:v3
    settings:
      chart: ./charts/tool-cron
      namespace: docs
      release: github-metrics
      # inline values string; keys must match charts/tool-cron/values.yaml
      values: >
        arch=arm64,
        image.repository=795250896452.dkr.ecr.us-east-1.amazonaws.com/docs/github-metrics,
        image.tag=git-${DRONE_COMMIT_SHA:0:7},
        schedule=0 2 * * *,
        secretsRef=github-metrics-secrets,
        configRef=github-metrics-config
      api_server: https://api.staging.corp.mongodb.com
      kubernetes_token:
        from_secret: staging_kubernetes_token
    when:
      event:
      - push
